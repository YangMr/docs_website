

# 封装组件高级篇（上）

## 5-1 本章概述

### 本章概述

通过前面章节的学习，我们已经完成了初级组件和中级组件的编写，这一章节，我们再次将难度升级，开始高级组件的编写，我们就先从表单组件开始。

### 将收获什么

- 支持`element-plus`表单所有组件
- 支持`element-plus`表单所有属性
- 支持`element-plus`表单所有方法
- 所有表单项完全可配置
- 集成富文本编辑器
- 支持弹框嵌套

### 学习难点

- 表单配置项设计
- 表单逻辑梳理
- 如何支持所有组件、属性和方法
- 如何集成富文本编辑器(第三方插件)
- 如何支持弹框内嵌套
- 如何与实际业务结合

### 学习方法

- 要有耐心，不要一心想着写代码，觉得需求和设计不重要
- 一定要动手敲，不要光看不做
- 有问题及时交流

### 注意事项

- 编写组件一定要从使用者出发，所以要考虑所以情况
- 尽量利用已有或现成的组件
- 遇到问题慢慢分析，不要怕遇到问题



## 5-2 表单组件-一个强大的表单组件应该具备哪些功能

### 一、功能

1. 可配置型表单, 通过 json 对象的方式自动生成表单
2. 具备更完善的功能, 表单验证, 动态删减表单, 集成第三方插件...
3. 用法简单. 扩展性强, 可维护性强
4. 能够用在更多的场景, 比如弹窗嵌套表单

### 二、准备工作

1. 分析`element plus`表单能够在哪方面做优化
2. 完善我们封装表单的类型, 支持 ts
3. 封装的表单要具备`element plus`原表单的所有功能
4. 集成第三方插件: markdown 编辑器、富文本编辑器...

### 三、搭建结构

1. 创建form组件并全局注册

   `components/form/src/index.vue`

   ```vue
   <template>
     <div>123</div>
   </template>
   
   <script lang="ts" setup></script>
   
   <style scoped lang="scss"></style>
   
   ```

   `components/form/index.ts`

   ```vue
   import { App } from "vue"
   import Form from "./src/index.vue"
   
   export default {
       install(app : App){
           app.component("m-form", Form)
       }
   }
   ```

   `components/index.ts`

   ```ts
   import {App} from "vue"
   import chooseArea from "./chooseArea"
   import chooseIcon from "./chooseIcon"
   import menu from "./menu"
   import form from "./form"
   
   const components = [
       chooseArea,
       chooseIcon,
       menu,
       form
   ]
   
   export default {
       install(app : App){
           components.map(item => {
               app.use(item)
           })
       }
          
   }
   ```

   

2. 创建form页面,并引入form组件与使用

   `views/form/index.vue`

   ```vue
   <template>
     <div>
       <m-form></m-form>
     </div>
   </template>
   
   <script lang="ts" setup></script>
   
   <style scoped lang="scss"></style>
   
   ```

3. 配置form路由

   `router/index.ts`

   ```ts
   import {createRouter,createWebHistory,RouteRecordRaw} from "vue-router"
   import Home from "../views/Home.vue"
   import Container from "../components/container/src/index.vue"
   const routes : RouteRecordRaw[] = [
       {
           path : "/",
           component : Container,
           children : [
               {
                   path : "/",
                   component : Home
               },
               {
                   path : "/chooseIcon",
                   component : () => import("../views/chooseIcon/index.vue")
               },
               {
                   path : "/chooseArea",
                   component : () => import("../views/chooseArea/index.vue")
               },
               {
                   path : "/menu",
                   component : () => import("../views/menu/index.vue")
               },
               {
                   path : "/form",
                   component : () => import("../views/form/index.vue")
               }
           ]
       },
       
   ]
   
   const router = createRouter({
       routes,
       history : createWebHistory()
   })
   
   export default router
   ```

   

## 5-3 表单组件-使用 ts 定义表单配置项的数据类型

1. 定义表单配置项ts类型

   `components/form/src/types/types.ts`

   ```ts
   // 可配置的表单
   
   import type { RuleItem } from "./rule"
   
   // 表单每一项的配置选项
   export interface FormOptions {
       // 表单项显示的元素
       type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
       'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
       'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
       'transfer' | 'upload' | 'editor' 
   
       // 表单项值
       value : any
   
       // 表单项标题
       label? : string
   
       // 表单项标识
       prop? : string
   
       // 表单项的验证规则
       rules? : RuleItem[]
   
       // 表单项的占位符
       placeholder? : string
   
       // 表单元素特有的属性
       attrs? : {
           // 是否清空
           clearable?: boolean,
           // 是否显示密码
           showPassword?: boolean,
           // 是否禁用
           disabled?: boolean,
       }
   }
   ```

2. 获取表单验证规则ts类型

   https://github.com/yiminghe/async-validator/blob/master/src/interface.ts

3. 定义rules规则

   `components/form/src/types/rule.ts`

   ```ts
   // >>>>> Rule
   // Modified from https://github.com/yiminghe/async-validator/blob/0d51d60086a127b21db76f44dff28ae18c165c47/src/index.d.ts
   export type RuleType =
     | 'string'
     | 'number'
     | 'boolean'
     | 'method'
     | 'regexp'
     | 'integer'
     | 'float'
     | 'array'
     | 'object'
     | 'enum'
     | 'date'
     | 'url'
     | 'hex'
     | 'email'
     | 'pattern'
     | 'any';
   
   export interface ValidateOption {
     // whether to suppress internal warning
     suppressWarning?: boolean;
   
     // whether to suppress validator error
     suppressValidatorError?: boolean;
   
     // when the first validation rule generates an error stop processed
     first?: boolean;
   
     // when the first validation rule of the specified field generates an error stop the field processed, 'true' means all fields.
     firstFields?: boolean | string[];
   
     messages?: Partial<ValidateMessages>;
   
     /** The name of rules need to be trigger. Will validate all rules if leave empty */
     keys?: string[];
   
     error?: (rule: InternalRuleItem, message: string) => ValidateError;
   }
   
   export type SyncErrorType = Error | string;
   export type SyncValidateResult = boolean | SyncErrorType | SyncErrorType[];
   export type ValidateResult = void | Promise<void> | SyncValidateResult;
   
   export interface RuleItem {
     type?: RuleType; // default type is 'string'
     required?: boolean;
     pattern?: RegExp | string;
     min?: number; // Range of type 'string' and 'array'
     max?: number; // Range of type 'string' and 'array'
     len?: number; // Length of type 'string' and 'array'
     enum?: Array<string | number | boolean | null | undefined>; // possible values of type 'enum'
     whitespace?: boolean;
     fields?: Record<string, Rule>; // ignore when without required
     options?: ValidateOption;
     defaultField?: Rule; // 'object' or 'array' containing validation rules
     transform?: (value: Value) => Value;
     message?: string | ((a?: string) => string);
     asyncValidator?: (
       rule: InternalRuleItem,
       value: Value,
       callback: (error?: string | Error) => void,
       source: Values,
       options: ValidateOption,
     ) => void | Promise<void>;
     validator?: (
       rule: InternalRuleItem,
       value: Value,
       callback: (error?: string | Error) => void,
       source: Values,
       options: ValidateOption,
     ) => SyncValidateResult | void;
   }
   
   export type Rule = RuleItem | RuleItem[];
   
   export type Rules = Record<string, Rule>;
   
   /**
    *  Rule for validating a value exists in an enumerable list.
    *
    *  @param rule The validation rule.
    *  @param value The value of the field on the source object.
    *  @param source The source object being validated.
    *  @param errors An array of errors that this rule may add
    *  validation errors to.
    *  @param options The validation options.
    *  @param options.messages The validation messages.
    *  @param type Rule type
    */
   export type ExecuteRule = (
     rule: InternalRuleItem,
     value: Value,
     source: Values,
     errors: string[],
     options: ValidateOption,
     type?: string,
   ) => void;
   
   /**
    *  Performs validation for any type.
    *
    *  @param rule The validation rule.
    *  @param value The value of the field on the source object.
    *  @param callback The callback function.
    *  @param source The source object being validated.
    *  @param options The validation options.
    *  @param options.messages The validation messages.
    */
   export type ExecuteValidator = (
     rule: InternalRuleItem,
     value: Value,
     callback: (error?: string[]) => void,
     source: Values,
     options: ValidateOption,
   ) => void;
   
   // >>>>> Message
   type ValidateMessage<T extends any[] = unknown[]> =
     | string
     | ((...args: T) => string);
   type FullField = string | undefined;
   type EnumString = string | undefined;
   type Pattern = string | RegExp | undefined;
   type Range = number | undefined;
   type Type = string | undefined;
   
   export interface ValidateMessages {
     default?: ValidateMessage;
     required?: ValidateMessage<[FullField]>;
     enum?: ValidateMessage<[FullField, EnumString]>;
     whitespace?: ValidateMessage<[FullField]>;
     date?: {
       format?: ValidateMessage;
       parse?: ValidateMessage;
       invalid?: ValidateMessage;
     };
     types?: {
       string?: ValidateMessage<[FullField, Type]>;
       method?: ValidateMessage<[FullField, Type]>;
       array?: ValidateMessage<[FullField, Type]>;
       object?: ValidateMessage<[FullField, Type]>;
       number?: ValidateMessage<[FullField, Type]>;
       date?: ValidateMessage<[FullField, Type]>;
       boolean?: ValidateMessage<[FullField, Type]>;
       integer?: ValidateMessage<[FullField, Type]>;
       float?: ValidateMessage<[FullField, Type]>;
       regexp?: ValidateMessage<[FullField, Type]>;
       email?: ValidateMessage<[FullField, Type]>;
       url?: ValidateMessage<[FullField, Type]>;
       hex?: ValidateMessage<[FullField, Type]>;
     };
     string?: {
       len?: ValidateMessage<[FullField, Range]>;
       min?: ValidateMessage<[FullField, Range]>;
       max?: ValidateMessage<[FullField, Range]>;
       range?: ValidateMessage<[FullField, Range, Range]>;
     };
     number?: {
       len?: ValidateMessage<[FullField, Range]>;
       min?: ValidateMessage<[FullField, Range]>;
       max?: ValidateMessage<[FullField, Range]>;
       range?: ValidateMessage<[FullField, Range, Range]>;
     };
     array?: {
       len?: ValidateMessage<[FullField, Range]>;
       min?: ValidateMessage<[FullField, Range]>;
       max?: ValidateMessage<[FullField, Range]>;
       range?: ValidateMessage<[FullField, Range, Range]>;
     };
     pattern?: {
       mismatch?: ValidateMessage<[FullField, Value, Pattern]>;
     };
   }
   
   export interface InternalValidateMessages extends ValidateMessages {
     clone: () => InternalValidateMessages;
   }
   
   // >>>>> Values
   export type Value = any;
   export type Values = Record<string, Value>;
   
   // >>>>> Validate
   export interface ValidateError {
     message?: string;
     fieldValue?: Value;
     field?: string;
   }
   
   export type ValidateFieldsError = Record<string, ValidateError[]>;
   
   export type ValidateCallback = (
     errors: ValidateError[] | null,
     fields: ValidateFieldsError | Values,
   ) => void;
   
   export interface RuleValuePackage {
     rule: InternalRuleItem;
     value: Value;
     source: Values;
     field: string;
   }
   
   export interface InternalRuleItem extends Omit<RuleItem, 'validator'> {
     field?: string;
     fullField?: string;
     fullFields?: string[];
     validator?: RuleItem['validator'] | ExecuteValidator;
   }
   ```

   

## 5-4 表单组件-使用配置的数据完成一个基本版表单

#### 1. 定义表单配置项数据

`views/form.vue`

```vue
<template>
  <div>
    <m-form :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
  },
  {
    type: "input",
    value: "",
    label: "密码",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
    },
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 2. 解决没有trigger类型的问题

![image-20240305093147850](/Users/yangling/Library/Application Support/typora-user-images/image-20240305093147850.png)

#### 3. 子组件接受表单配置项数据

`components/form/src/index.vue`

```vue
<script lang="ts" setup>
import type { PropType } from "vue";
import type { FormOptions } from "./types/types";
defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});
</script>

```

#### 4. 根据表单配置项数据渲染表单

`components/form/src/index.vue`

```vue
<template>
  <el-form>
    <el-form-item
      :label="item.label"
      v-for="(item, index) in options"
      :key="index"
    >
      <component :is="`el-${item.type}`"></component>
    </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import type { PropType } from "vue";
import type { FormOptions } from "./types/types";
defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});
</script>

<style scoped lang="scss"></style>

```

#### 5. 扩展表单内置属性

`components/form/src/index.vue`

```vue
<template>
  <el-form :model="model" :rules="rules" v-bind="$attrs">
    <el-form-item
      :label="item.label"
      v-for="(item, index) in options"
      :key="index"
    >
      <component  v-bind="item.attrs" :is="`el-${item.type}`"></component>
    </el-form-item>
  </el-form>
</template>
```

`views/form.vue`

```vue
 <m-form label-width="100px" :options="options"></m-form>
```

#### 6. 解决表单数据与规则校验问题

`components/form/src/index.vue`

```vue
<template>
  <el-form :model="model" :rules="rules" v-bind="$attrs">
    <el-form-item
      :prop="item.prop"
      :label="item.label"
      v-for="(item, index) in options"
      :key="index"
    >
      <component
         v-bind="item.attrs"
        v-model="model[item.prop!]"
        :is="`el-${item.type}`"
      ></component>
    </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>({});
let rules = ref<any>({});

// dom加载时
onMounted(() => {
  let m: any = {};
  let r: any = {};

  props.options.map((item: FormOptions) => {
    m[item.prop!] = item.value;
    r[item.prop!] = item.rules;
  });

  model.value = cloneDeep(m);
  rules.value = cloneDeep(r);
});
</script>

<style scoped lang="scss"></style>

```

安装lodash库, 使用深拷贝方法

```shell
npm i lodash  -S @types/lodash
```

`views/form.vue`

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 7. 解决表单验证规则立即触发的问题

`components/form/src/index.vue`

`:validate-on-rule-change="false" `让表单验证规则第一次不生效

```vue
<el-form
    :validate-on-rule-change="false" 
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
```



## 5-5 表单组件-巧用 component 动态组件配置添加子元素组件

#### 1. 添加子类型

```ts
// 可配置的表单

import type { RuleItem } from "./rule"

// 表单每一项的配置选项
export interface FormOptions {
    // 表单项显示的元素
    type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
    'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
    'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
    'transfer' | 'upload' | 'editor' 

    // 表单项值
    value : any

    // 表单项标题
    label? : string

    // 表单项标识
    prop? : string

    // 表单项的验证规则
    rules? : RuleItem[]

    // 表单项的占位符
    placeholder? : string

    // 表单元素特有的属性
    attrs? : {
        // 是否清空
        clearable?: boolean,
        // 是否显示密码
        showPassword?: boolean,
        // 是否禁用
        disabled?: boolean,
    }

    // 表单项的子元素
    children? : FormOptions[]
}
```

#### 2. 配置下拉框配置项数据

`views/form.vue`

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    placeholder: "请选择职位",
    value: "",
    prop: "role",
    label: "职位",
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "blur",
      },
    ],
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 3. 渲染下拉框

`components/form/src/index.vue`

```vue
<template>
  <el-form
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options" :key="index">
      
      <!-- 没有children -->
      <el-form-item
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>
      </el-form-item>
      
      <!-- 有children -->
      <el-form-item
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>({});
let rules = ref<any>({});

// dom加载时
onMounted(() => {
  let m: any = {};
  let r: any = {};

  props.options.map((item: FormOptions) => {
    m[item.prop!] = item.value;
    r[item.prop!] = item.rules;
  });

  model.value = cloneDeep(m);
  rules.value = cloneDeep(r);
});
</script>

<style scoped lang="scss"></style>

```

#### 4. 设置自定义样式

1. 配置样式ts类型

   ```ts
   // 可配置的表单
   
   import type { RuleItem } from "./rule"
   
   import type {CSSProperties} from "vue"
   
   // 表单每一项的配置选项
   export interface FormOptions {
       // 表单项显示的元素
       type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
       'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
       'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
       'transfer' | 'upload' | 'editor' 
   
       // 表单项值
       value : any
   
       // 表单项标题
       label? : string
   
       // 表单项标识
       prop? : string
   
       // 表单项的验证规则
       rules? : RuleItem[]
   
       // 表单项的占位符
       placeholder? : string
   
       // 表单元素特有的属性
       attrs? : {
           // css样式
           style? : CSSProperties
           // 是否清空
           clearable?: boolean,
           // 是否显示密码
           showPassword?: boolean,
           // 是否禁用
           disabled?: boolean,
       }
   
       // 表单项的子元素
       children? : FormOptions[]
   }
   ```

2. 定义样式

   `views/form/index.vue`

   ```ts
   {
       type: "select",
       placeholder: "请选择职位",
       value: "",
       prop: "role",
       label: "职位",
       rules: [
         {
           required: true,
           message: "职位不能为空",
           trigger: "blur",
         },
       ],
       attrs: {
         style: {
           width: "100%",
         },
       },
       children: [
         {
           type: "option",
           label: "经理",
           value: "1",
         },
         {
           type: "option",
           label: "主管",
           value: "2",
         },
         {
           type: "option",
           label: "员工",
           value: "3",
         },
       ],
     },
   ```

#### 5.配置多选组配置项数据 

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    placeholder: "请选择职位",
    value: "",
    prop: "role",
    label: "职位",
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "blur",
      },
    ],
    attrs: {
      style: {
        width: "100%",
      },
    },
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
  {
    type: "checkbox-group",
    value: [],
    label: "爱好",
    prop: "like",
    children: [
      {
        type: "checkbox",
        label: "足球",
        value: "1",
      },
      {
        type: "checkbox",
        label: "蓝球",
        value: "2",
      },
      {
        type: "checkbox",
        label: "排球",
        value: "3",
      },
    ],
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 6. 实现多选组渲染

```vue
<template>
  <el-form
    v-if="model"
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options" :key="index">
      <!-- 没有children -->
      <el-form-item
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>
      </el-form-item>
      <!-- 有children -->
      <el-form-item
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>(null);
let rules = ref<any>(null);

// 初始化表单方法
let initForm = () => {
  if (props.options && props.options.length) {
    let m: any = {};
    let r: any = {};

    props.options.map((item: FormOptions) => {
      m[item.prop!] = item.value;
      r[item.prop!] = item.rules;
    });

    model.value = cloneDeep(m);
    rules.value = cloneDeep(r);
  }
};

// dom加载时
onMounted(() => {
  initForm();
});
</script>

<style scoped lang="scss"></style>

```

#### 7. 实现单选组配置项数据

`views/form/index.vue`

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    placeholder: "请选择职位",
    value: "",
    prop: "role",
    label: "职位",
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "blur",
      },
    ],
    attrs: {
      style: {
        width: "100%",
      },
    },
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
  {
    type: "checkbox-group",
    value: [],
    label: "爱好",
    prop: "like",
    rules: [
      {
        required: true,
        message: "爱好不能为空",
        trigger: "blur",
      },
    ],
    children: [
      {
        type: "checkbox",
        label: "足球",
        value: "1",
      },
      {
        type: "checkbox",
        label: "蓝球",
        value: "2",
      },
      {
        type: "checkbox",
        label: "排球",
        value: "3",
      },
    ],
  },
  {
    type: "radio-group",
    value: "",
    label: "性别",
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "blur",
      },
    ],
    prop: "gender",
    children: [
      {
        type: "radio",
        label: "男",
        value: "male",
      },
      {
        type: "radio",
        label: "女",
        value: "female",
      },
      {
        type: "radio",
        label: "保密",
        value: "not",
      },
    ],
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 8. 监听父组件传递过来的options变化

`comonents/form/src/index.vue`

```ts
<script lang="ts" setup>
import { ref, type PropType, onMounted, watch } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>(null);
let rules = ref<any>(null);

// 初始化表单方法
let initForm = () => {
  if (props.options && props.options.length) {
    let m: any = {};
    let r: any = {};

    props.options.map((item: FormOptions) => {
      m[item.prop!] = item.value;
      r[item.prop!] = item.rules;
    });

    model.value = cloneDeep(m);
    rules.value = cloneDeep(r);
  }
};

// dom加载时
onMounted(() => {
  initForm();
});

// 监听父组件传递过来的options变化
watch(
  () => props.options,
  () => {
    initForm();
  },
  {
    deep: true,
  }
);
</script>
```



## 5-6 表单组件-单独处理上传组件-1

## 5-7 表单组件-单独处理上传组件-2

## 5-8 表单组件-巧用插槽给表单加上操作项

## 5-9 表单组件-完善表单上传逻辑

## 5-10 表单组件-集成富文本编辑器 wangeditor

## 5-11 表单组件-完善表单重置逻辑

## 5-13 表单组件-使用 defineExpose 获取表单实例方法

## 5-14 表单组件-完善表单逻辑

## 5-15 表单组件-表单组件总结

## 5-16 拓展动态添加和删除表单

**题目描述:**
通过前面的章节，我们已经完成了表单组件，因为表单通过配置选项生成的，我们可以任意增加或删除表单项。
**提示:**

1. 将配置选项定义为一个数组。
2. 对数组做增加或删除操作。

## 5-17 为表单增加自定义验证规则

**题目描述:**
通过前面的章节，我们已经完成了表单组件，现在为表单增加自定义验证规则。
**提示:**

1. 将配置选项定义`rules`时增加`validator`属性

## 5-18 为表单增加剩余实例方法

**题目描述:**
通过前面的章节，我们已经完成了表单组件，现在为表单增加剩余实例方法
**提示:**

1. 通过`defineExpose`暴露实例方法。
2. 暴露`validateField`、`scrollToField`、`clearValidate`方法

## 5-19 本章回顾

我们一起来回顾本章的重点内容

- 表单组件
  - 配置项类型定义
  - 动态组件的使用
  - 插槽的使用
  - 处理上传组件
  - 集成富文本编辑器
  - 支持弹框嵌套
  - `defineExpose`新属性的使用
  - 表单逻辑完善
