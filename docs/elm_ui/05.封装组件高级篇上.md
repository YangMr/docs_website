

# 封装组件高级篇（上）

## 5-1 本章概述

### 本章概述

通过前面章节的学习，我们已经完成了初级组件和中级组件的编写，这一章节，我们再次将难度升级，开始高级组件的编写，我们就先从表单组件开始。

### 将收获什么

- 支持`element-plus`表单所有组件
- 支持`element-plus`表单所有属性
- 支持`element-plus`表单所有方法
- 所有表单项完全可配置
- 集成富文本编辑器
- 支持弹框嵌套

### 学习难点

- 表单配置项设计
- 表单逻辑梳理
- 如何支持所有组件、属性和方法
- 如何集成富文本编辑器(第三方插件)
- 如何支持弹框内嵌套
- 如何与实际业务结合

### 学习方法

- 要有耐心，不要一心想着写代码，觉得需求和设计不重要
- 一定要动手敲，不要光看不做
- 有问题及时交流

### 注意事项

- 编写组件一定要从使用者出发，所以要考虑所以情况
- 尽量利用已有或现成的组件
- 遇到问题慢慢分析，不要怕遇到问题



## 5-2 表单组件-一个强大的表单组件应该具备哪些功能

### 一、功能

1. 可配置型表单, 通过 json 对象的方式自动生成表单
2. 具备更完善的功能, 表单验证, 动态删减表单, 集成第三方插件...
3. 用法简单. 扩展性强, 可维护性强
4. 能够用在更多的场景, 比如弹窗嵌套表单

### 二、准备工作

1. 分析`element plus`表单能够在哪方面做优化
2. 完善我们封装表单的类型, 支持 ts
3. 封装的表单要具备`element plus`原表单的所有功能
4. 集成第三方插件: markdown 编辑器、富文本编辑器...

### 三、搭建结构

1. 创建form组件并全局注册

   `components/form/src/index.vue`

   ```vue
   <template>
     <div>123</div>
   </template>
   
   <script lang="ts" setup></script>
   
   <style scoped lang="scss"></style>
   
   ```

   `components/form/index.ts`

   ```vue
   import { App } from "vue"
   import Form from "./src/index.vue"
   
   export default {
       install(app : App){
           app.component("m-form", Form)
       }
   }
   ```

   `components/index.ts`

   ```ts
   import {App} from "vue"
   import chooseArea from "./chooseArea"
   import chooseIcon from "./chooseIcon"
   import menu from "./menu"
   import form from "./form"
   
   const components = [
       chooseArea,
       chooseIcon,
       menu,
       form
   ]
   
   export default {
       install(app : App){
           components.map(item => {
               app.use(item)
           })
       }
          
   }
   ```

   

2. 创建form页面,并引入form组件与使用

   `views/form/index.vue`

   ```vue
   <template>
     <div>
       <m-form></m-form>
     </div>
   </template>
   
   <script lang="ts" setup></script>
   
   <style scoped lang="scss"></style>
   
   ```

3. 配置form路由

   `router/index.ts`

   ```ts
   import {createRouter,createWebHistory,RouteRecordRaw} from "vue-router"
   import Home from "../views/Home.vue"
   import Container from "../components/container/src/index.vue"
   const routes : RouteRecordRaw[] = [
       {
           path : "/",
           component : Container,
           children : [
               {
                   path : "/",
                   component : Home
               },
               {
                   path : "/chooseIcon",
                   component : () => import("../views/chooseIcon/index.vue")
               },
               {
                   path : "/chooseArea",
                   component : () => import("../views/chooseArea/index.vue")
               },
               {
                   path : "/menu",
                   component : () => import("../views/menu/index.vue")
               },
               {
                   path : "/form",
                   component : () => import("../views/form/index.vue")
               }
           ]
       },
       
   ]
   
   const router = createRouter({
       routes,
       history : createWebHistory()
   })
   
   export default router
   ```

   

## 5-3 表单组件-使用 ts 定义表单配置项的数据类型

1. 定义表单配置项ts类型

   `components/form/src/types/types.ts`

   ```ts
   // 可配置的表单
   
   import type { RuleItem } from "./rule"
   
   // 表单每一项的配置选项
   export interface FormOptions {
       // 表单项显示的元素
       type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
       'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
       'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
       'transfer' | 'upload' | 'editor' 
   
       // 表单项值
       value : any
   
       // 表单项标题
       label? : string
   
       // 表单项标识
       prop? : string
   
       // 表单项的验证规则
       rules? : RuleItem[]
   
       // 表单项的占位符
       placeholder? : string
   
       // 表单元素特有的属性
       attrs? : {
           // 是否清空
           clearable?: boolean,
           // 是否显示密码
           showPassword?: boolean,
           // 是否禁用
           disabled?: boolean,
       }
   }
   ```

2. 获取表单验证规则ts类型

   https://github.com/yiminghe/async-validator/blob/master/src/interface.ts

3. 定义rules规则

   `components/form/src/types/rule.ts`

   ```ts
   // >>>>> Rule
   // Modified from https://github.com/yiminghe/async-validator/blob/0d51d60086a127b21db76f44dff28ae18c165c47/src/index.d.ts
   export type RuleType =
     | 'string'
     | 'number'
     | 'boolean'
     | 'method'
     | 'regexp'
     | 'integer'
     | 'float'
     | 'array'
     | 'object'
     | 'enum'
     | 'date'
     | 'url'
     | 'hex'
     | 'email'
     | 'pattern'
     | 'any';
   
   export interface ValidateOption {
     // whether to suppress internal warning
     suppressWarning?: boolean;
   
     // whether to suppress validator error
     suppressValidatorError?: boolean;
   
     // when the first validation rule generates an error stop processed
     first?: boolean;
   
     // when the first validation rule of the specified field generates an error stop the field processed, 'true' means all fields.
     firstFields?: boolean | string[];
   
     messages?: Partial<ValidateMessages>;
   
     /** The name of rules need to be trigger. Will validate all rules if leave empty */
     keys?: string[];
   
     error?: (rule: InternalRuleItem, message: string) => ValidateError;
   }
   
   export type SyncErrorType = Error | string;
   export type SyncValidateResult = boolean | SyncErrorType | SyncErrorType[];
   export type ValidateResult = void | Promise<void> | SyncValidateResult;
   
   export interface RuleItem {
     type?: RuleType; // default type is 'string'
     required?: boolean;
     pattern?: RegExp | string;
     min?: number; // Range of type 'string' and 'array'
     max?: number; // Range of type 'string' and 'array'
     len?: number; // Length of type 'string' and 'array'
     enum?: Array<string | number | boolean | null | undefined>; // possible values of type 'enum'
     whitespace?: boolean;
     fields?: Record<string, Rule>; // ignore when without required
     options?: ValidateOption;
     defaultField?: Rule; // 'object' or 'array' containing validation rules
     transform?: (value: Value) => Value;
     message?: string | ((a?: string) => string);
     asyncValidator?: (
       rule: InternalRuleItem,
       value: Value,
       callback: (error?: string | Error) => void,
       source: Values,
       options: ValidateOption,
     ) => void | Promise<void>;
     validator?: (
       rule: InternalRuleItem,
       value: Value,
       callback: (error?: string | Error) => void,
       source: Values,
       options: ValidateOption,
     ) => SyncValidateResult | void;
   }
   
   export type Rule = RuleItem | RuleItem[];
   
   export type Rules = Record<string, Rule>;
   
   /**
    *  Rule for validating a value exists in an enumerable list.
    *
    *  @param rule The validation rule.
    *  @param value The value of the field on the source object.
    *  @param source The source object being validated.
    *  @param errors An array of errors that this rule may add
    *  validation errors to.
    *  @param options The validation options.
    *  @param options.messages The validation messages.
    *  @param type Rule type
    */
   export type ExecuteRule = (
     rule: InternalRuleItem,
     value: Value,
     source: Values,
     errors: string[],
     options: ValidateOption,
     type?: string,
   ) => void;
   
   /**
    *  Performs validation for any type.
    *
    *  @param rule The validation rule.
    *  @param value The value of the field on the source object.
    *  @param callback The callback function.
    *  @param source The source object being validated.
    *  @param options The validation options.
    *  @param options.messages The validation messages.
    */
   export type ExecuteValidator = (
     rule: InternalRuleItem,
     value: Value,
     callback: (error?: string[]) => void,
     source: Values,
     options: ValidateOption,
   ) => void;
   
   // >>>>> Message
   type ValidateMessage<T extends any[] = unknown[]> =
     | string
     | ((...args: T) => string);
   type FullField = string | undefined;
   type EnumString = string | undefined;
   type Pattern = string | RegExp | undefined;
   type Range = number | undefined;
   type Type = string | undefined;
   
   export interface ValidateMessages {
     default?: ValidateMessage;
     required?: ValidateMessage<[FullField]>;
     enum?: ValidateMessage<[FullField, EnumString]>;
     whitespace?: ValidateMessage<[FullField]>;
     date?: {
       format?: ValidateMessage;
       parse?: ValidateMessage;
       invalid?: ValidateMessage;
     };
     types?: {
       string?: ValidateMessage<[FullField, Type]>;
       method?: ValidateMessage<[FullField, Type]>;
       array?: ValidateMessage<[FullField, Type]>;
       object?: ValidateMessage<[FullField, Type]>;
       number?: ValidateMessage<[FullField, Type]>;
       date?: ValidateMessage<[FullField, Type]>;
       boolean?: ValidateMessage<[FullField, Type]>;
       integer?: ValidateMessage<[FullField, Type]>;
       float?: ValidateMessage<[FullField, Type]>;
       regexp?: ValidateMessage<[FullField, Type]>;
       email?: ValidateMessage<[FullField, Type]>;
       url?: ValidateMessage<[FullField, Type]>;
       hex?: ValidateMessage<[FullField, Type]>;
     };
     string?: {
       len?: ValidateMessage<[FullField, Range]>;
       min?: ValidateMessage<[FullField, Range]>;
       max?: ValidateMessage<[FullField, Range]>;
       range?: ValidateMessage<[FullField, Range, Range]>;
     };
     number?: {
       len?: ValidateMessage<[FullField, Range]>;
       min?: ValidateMessage<[FullField, Range]>;
       max?: ValidateMessage<[FullField, Range]>;
       range?: ValidateMessage<[FullField, Range, Range]>;
     };
     array?: {
       len?: ValidateMessage<[FullField, Range]>;
       min?: ValidateMessage<[FullField, Range]>;
       max?: ValidateMessage<[FullField, Range]>;
       range?: ValidateMessage<[FullField, Range, Range]>;
     };
     pattern?: {
       mismatch?: ValidateMessage<[FullField, Value, Pattern]>;
     };
   }
   
   export interface InternalValidateMessages extends ValidateMessages {
     clone: () => InternalValidateMessages;
   }
   
   // >>>>> Values
   export type Value = any;
   export type Values = Record<string, Value>;
   
   // >>>>> Validate
   export interface ValidateError {
     message?: string;
     fieldValue?: Value;
     field?: string;
   }
   
   export type ValidateFieldsError = Record<string, ValidateError[]>;
   
   export type ValidateCallback = (
     errors: ValidateError[] | null,
     fields: ValidateFieldsError | Values,
   ) => void;
   
   export interface RuleValuePackage {
     rule: InternalRuleItem;
     value: Value;
     source: Values;
     field: string;
   }
   
   export interface InternalRuleItem extends Omit<RuleItem, 'validator'> {
     field?: string;
     fullField?: string;
     fullFields?: string[];
     validator?: RuleItem['validator'] | ExecuteValidator;
   }
   ```

   

## 5-4 表单组件-使用配置的数据完成一个基本版表单

#### 1. 定义表单配置项数据

`views/form.vue`

```vue
<template>
  <div>
    <m-form :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
  },
  {
    type: "input",
    value: "",
    label: "密码",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
    },
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 2. 解决没有trigger类型的问题

![image-20240305093147850](/Users/yangling/Library/Application Support/typora-user-images/image-20240305093147850.png)

#### 3. 子组件接受表单配置项数据

`components/form/src/index.vue`

```vue
<script lang="ts" setup>
import type { PropType } from "vue";
import type { FormOptions } from "./types/types";
defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});
</script>

```

#### 4. 根据表单配置项数据渲染表单

`components/form/src/index.vue`

```vue
<template>
  <el-form>
    <el-form-item
      :label="item.label"
      v-for="(item, index) in options"
      :key="index"
    >
      <component :is="`el-${item.type}`"></component>
    </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import type { PropType } from "vue";
import type { FormOptions } from "./types/types";
defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});
</script>

<style scoped lang="scss"></style>

```

#### 5. 扩展表单内置属性

`components/form/src/index.vue`

```vue
<template>
  <el-form :model="model" :rules="rules" v-bind="$attrs">
    <el-form-item
      :label="item.label"
      v-for="(item, index) in options"
      :key="index"
    >
      <component  v-bind="item.attrs" :is="`el-${item.type}`"></component>
    </el-form-item>
  </el-form>
</template>
```

`views/form.vue`

```vue
 <m-form label-width="100px" :options="options"></m-form>
```

#### 6. 解决表单数据与规则校验问题

`components/form/src/index.vue`

```vue
<template>
  <el-form :model="model" :rules="rules" v-bind="$attrs">
    <el-form-item
      :prop="item.prop"
      :label="item.label"
      v-for="(item, index) in options"
      :key="index"
    >
      <component
         v-bind="item.attrs"
        v-model="model[item.prop!]"
        :is="`el-${item.type}`"
      ></component>
    </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>({});
let rules = ref<any>({});

// dom加载时
onMounted(() => {
  let m: any = {};
  let r: any = {};

  props.options.map((item: FormOptions) => {
    m[item.prop!] = item.value;
    r[item.prop!] = item.rules;
  });

  model.value = cloneDeep(m);
  rules.value = cloneDeep(r);
});
</script>

<style scoped lang="scss"></style>

```

安装lodash库, 使用深拷贝方法

```shell
npm i lodash  -S @types/lodash
```

`views/form.vue`

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 7. 解决表单验证规则立即触发的问题

`components/form/src/index.vue`

`:validate-on-rule-change="false" `让表单验证规则第一次不生效

```vue
<el-form
    :validate-on-rule-change="false" 
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
```



## 5-5 表单组件-巧用 component 动态组件配置添加子元素组件

#### 1. 添加子类型

```ts
// 可配置的表单

import type { RuleItem } from "./rule"

// 表单每一项的配置选项
export interface FormOptions {
    // 表单项显示的元素
    type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
    'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
    'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
    'transfer' | 'upload' | 'editor' 

    // 表单项值
    value : any

    // 表单项标题
    label? : string

    // 表单项标识
    prop? : string

    // 表单项的验证规则
    rules? : RuleItem[]

    // 表单项的占位符
    placeholder? : string

    // 表单元素特有的属性
    attrs? : {
        // 是否清空
        clearable?: boolean,
        // 是否显示密码
        showPassword?: boolean,
        // 是否禁用
        disabled?: boolean,
    }

    // 表单项的子元素
    children? : FormOptions[]
}
```

#### 2. 配置下拉框配置项数据

`views/form.vue`

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    placeholder: "请选择职位",
    value: "",
    prop: "role",
    label: "职位",
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "blur",
      },
    ],
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 3. 渲染下拉框

`components/form/src/index.vue`

```vue
<template>
  <el-form
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options" :key="index">
      
      <!-- 没有children -->
      <el-form-item
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>
      </el-form-item>
      
      <!-- 有children -->
      <el-form-item
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>({});
let rules = ref<any>({});

// dom加载时
onMounted(() => {
  let m: any = {};
  let r: any = {};

  props.options.map((item: FormOptions) => {
    m[item.prop!] = item.value;
    r[item.prop!] = item.rules;
  });

  model.value = cloneDeep(m);
  rules.value = cloneDeep(r);
});
</script>

<style scoped lang="scss"></style>

```

#### 4. 设置自定义样式

1. 配置样式ts类型

   ```ts
   // 可配置的表单
   
   import type { RuleItem } from "./rule"
   
   import type {CSSProperties} from "vue"
   
   // 表单每一项的配置选项
   export interface FormOptions {
       // 表单项显示的元素
       type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
       'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
       'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
       'transfer' | 'upload' | 'editor' 
   
       // 表单项值
       value : any
   
       // 表单项标题
       label? : string
   
       // 表单项标识
       prop? : string
   
       // 表单项的验证规则
       rules? : RuleItem[]
   
       // 表单项的占位符
       placeholder? : string
   
       // 表单元素特有的属性
       attrs? : {
           // css样式
           style? : CSSProperties
           // 是否清空
           clearable?: boolean,
           // 是否显示密码
           showPassword?: boolean,
           // 是否禁用
           disabled?: boolean,
       }
   
       // 表单项的子元素
       children? : FormOptions[]
   }
   ```

2. 定义样式

   `views/form/index.vue`

   ```ts
   {
       type: "select",
       placeholder: "请选择职位",
       value: "",
       prop: "role",
       label: "职位",
       rules: [
         {
           required: true,
           message: "职位不能为空",
           trigger: "blur",
         },
       ],
       attrs: {
         style: {
           width: "100%",
         },
       },
       children: [
         {
           type: "option",
           label: "经理",
           value: "1",
         },
         {
           type: "option",
           label: "主管",
           value: "2",
         },
         {
           type: "option",
           label: "员工",
           value: "3",
         },
       ],
     },
   ```

#### 5.配置多选组配置项数据 

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    placeholder: "请选择职位",
    value: "",
    prop: "role",
    label: "职位",
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "blur",
      },
    ],
    attrs: {
      style: {
        width: "100%",
      },
    },
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
  {
    type: "checkbox-group",
    value: [],
    label: "爱好",
    prop: "like",
    children: [
      {
        type: "checkbox",
        label: "足球",
        value: "1",
      },
      {
        type: "checkbox",
        label: "蓝球",
        value: "2",
      },
      {
        type: "checkbox",
        label: "排球",
        value: "3",
      },
    ],
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 6. 实现多选组渲染

```vue
<template>
  <el-form
    v-if="model"
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options" :key="index">
      <!-- 没有children -->
      <el-form-item
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>
      </el-form-item>
      <!-- 有children -->
      <el-form-item
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>(null);
let rules = ref<any>(null);

// 初始化表单方法
let initForm = () => {
  if (props.options && props.options.length) {
    let m: any = {};
    let r: any = {};

    props.options.map((item: FormOptions) => {
      m[item.prop!] = item.value;
      r[item.prop!] = item.rules;
    });

    model.value = cloneDeep(m);
    rules.value = cloneDeep(r);
  }
};

// dom加载时
onMounted(() => {
  initForm();
});
</script>

<style scoped lang="scss"></style>

```

#### 7. 实现单选组配置项数据

`views/form/index.vue`

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options"></m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    placeholder: "请选择职位",
    value: "",
    prop: "role",
    label: "职位",
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "blur",
      },
    ],
    attrs: {
      style: {
        width: "100%",
      },
    },
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
  {
    type: "checkbox-group",
    value: [],
    label: "爱好",
    prop: "like",
    rules: [
      {
        required: true,
        message: "爱好不能为空",
        trigger: "blur",
      },
    ],
    children: [
      {
        type: "checkbox",
        label: "足球",
        value: "1",
      },
      {
        type: "checkbox",
        label: "蓝球",
        value: "2",
      },
      {
        type: "checkbox",
        label: "排球",
        value: "3",
      },
    ],
  },
  {
    type: "radio-group",
    value: "",
    label: "性别",
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "blur",
      },
    ],
    prop: "gender",
    children: [
      {
        type: "radio",
        label: "男",
        value: "male",
      },
      {
        type: "radio",
        label: "女",
        value: "female",
      },
      {
        type: "radio",
        label: "保密",
        value: "not",
      },
    ],
  },
];
</script>

<style scoped lang="scss"></style>

```

#### 8. 监听父组件传递过来的options变化

`comonents/form/src/index.vue`

```ts
<script lang="ts" setup>
import { ref, type PropType, onMounted, watch } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>(null);
let rules = ref<any>(null);

// 初始化表单方法
let initForm = () => {
  if (props.options && props.options.length) {
    let m: any = {};
    let r: any = {};

    props.options.map((item: FormOptions) => {
      m[item.prop!] = item.value;
      r[item.prop!] = item.rules;
    });

    model.value = cloneDeep(m);
    rules.value = cloneDeep(r);
  }
};

// dom加载时
onMounted(() => {
  initForm();
});

// 监听父组件传递过来的options变化
watch(
  () => props.options,
  () => {
    initForm();
  },
  {
    deep: true,
  }
);
</script>
```



## 5-6 表单组件-单独处理上传组件-1

#### 1. 配置上传组件数据

```ts
{
    type: "upload",
    label: "上传",
    prop: "pic",
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "blur",
      },
    ],
},
```

#### 2. 将value变成可选属性

```ts
export interface FormOptions {
    // 表单项显示的元素
    type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
    'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
    'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
    'transfer' | 'upload' | 'editor' 

    // 表单项值
    value? : any

```

#### 3. 渲染上传组件

```vue
<!-- 没有children -->
      <el-form-item
        :key="index"
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <!-- 如果type 不是 upload, 则使用component 加载对应的组件 -->
        <component
          v-if="item.type !== 'upload'"
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>

        <!-- 如果type 是 upload, 则使用el-upload组件 -->
        <el-upload  v-else>
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
        </el-upload>
      </el-form-item>
```

```vue
<template>
  <div>
    <m-form label-width="100px" :options="options">
      <template #uploadArea>
        <el-button type="primary">Click to upload</el-button>
      </template>

      <template #uploadTip>
        <div style="color: #ccc; font-size: 12px">
          jpg/png files with a size less than 500KB.
        </div>
      </template>
    </m-form>
  </div>
</template>

```

#### 4. 定义上传组件的属性和方法

`views/form/index.vue`

```ts
{
    type: "upload",
    label: "上传",
    prop: "pic",
    uploadAttrs: {
      action: "https://run.mocky.io/v3/9d059bf9-4660-45f2-925d-ce80ad6c4d15",
    },
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "blur",
      },
    ],
  },
```

`components/form/src/index.vue`

```vue
<template>
  <el-form
    v-if="model"
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options">
      <!-- 没有children -->
      <el-form-item
        :key="index"
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <!-- 如果type 不是 upload, 则使用component 加载对应的组件 -->
        <component
          v-if="item.type !== 'upload'"
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>

        <!-- 如果type 是 upload, 则使用el-upload组件 -->
        <el-upload
          v-bind="item.uploadAttrs"
          v-else
          :on-preview="onPreview"
          :on-remove="onRemove"
          :on-success="onSuccess"
          :on-error="onError"
          :on-progress="onProgress"
          :on-change="onChange"
          :before-upload="beforeUpload"
          :before-remove="beforeRemove"
          :on-exceed="onExceed"
        >
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
        </el-upload>
      </el-form-item>
      <!-- 有children -->
      <el-form-item
        :key="index"
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted, watch } from "vue";
import type { FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
});

// 表单数据
let model = ref<any>(null);
let rules = ref<any>(null);

// 初始化表单方法
let initForm = () => {
  if (props.options && props.options.length) {
    let m: any = {};
    let r: any = {};

    props.options.map((item: FormOptions) => {
      m[item.prop!] = item.value;
      r[item.prop!] = item.rules;
    });

    model.value = cloneDeep(m);
    rules.value = cloneDeep(r);
  }
};

// dom加载时
onMounted(() => {
  initForm();
});

// 监听父组件传递过来的options变化
watch(
  () => props.options,
  () => {
    initForm();
  },
  {
    deep: true,
  }
);

let emits = defineEmits([
  "on-preview",
  "on-remove",
  "on-success",
  "on-error",
  "on-progress",
  "on-change",
  "before-upload",
  "before-remove",
  "on-exceed",
]);

// 上传组件的所有方法
let onPreview = (file: File) => {
  emits("on-preview", file);
};
let onRemove = (file: File, fileList: FileList) => {
  emits("on-remove", { file, fileList });
};
let onSuccess = (response: any, file: File, fileList: FileList) => {
  // 上传图片成功 给表单上传项赋值
  let uploadItem = props.options.find((item) => item.type === "upload")!;
  model.value[uploadItem.prop!] = { response, file, fileList };
  emits("on-success", { response, file, fileList });
};
let onError = (err: any, file: File, fileList: FileList) => {
  emits("on-error", { err, file, fileList });
};
let onProgress = (event: any, file: File, fileList: FileList) => {
  emits("on-progress", { event, file, fileList });
};
let onChange = (file: File, fileList: FileList) => {
  emits("on-change", { file, fileList });
};
let beforeUpload = (file: File) => {
  emits("before-upload", file);
};
let beforeRemove = (file: File, fileList: FileList) => {
  emits("before-remove", { file, fileList });
};
let onExceed = (files: File, fileList: FileList) => {
  emits("on-exceed", { files, fileList });
};
</script>

<style scoped lang="scss"></style>

```



## 5-7 表单组件-单独处理上传组件-2

#### 1.   父组件监听文件上传所有事件方法

```vue
<template>
  <div>
    <m-form
      label-width="100px"
      :options="options"
      @on-change="handleChange"
      @before-upload="handleBeforeUpload"
      @on-preview="handlePreview"
      @on-remove="handleRemove"
      @before-remove="beforeRemove"
      @on-success="handleSuccess"
      @on-exceed="handleExceed"
    >
      <template #uploadArea>
        <el-button type="primary">Click to upload</el-button>
      </template>

      <template #uploadTip>
        <div style="color: #ccc; font-size: 12px">
          jpg/png files with a size less than 500KB.
        </div>
      </template>
    </m-form>
  </div>
</template>

<script lang="ts" setup>
import type { FormOptions } from "../../components/form/src/types/types";
import { ElMessage, ElMessageBox } from "element-plus";

let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    placeholder: "请选择职位",
    value: "",
    prop: "role",
    label: "职位",
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "blur",
      },
    ],
    attrs: {
      style: {
        width: "100%",
      },
    },
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
  {
    type: "checkbox-group",
    value: [],
    label: "爱好",
    prop: "like",
    rules: [
      {
        required: true,
        message: "爱好不能为空",
        trigger: "blur",
      },
    ],
    children: [
      {
        type: "checkbox",
        label: "足球",
        value: "1",
      },
      {
        type: "checkbox",
        label: "蓝球",
        value: "2",
      },
      {
        type: "checkbox",
        label: "排球",
        value: "3",
      },
    ],
  },
  {
    type: "radio-group",
    value: "",
    label: "性别",
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "blur",
      },
    ],
    prop: "gender",
    children: [
      {
        type: "radio",
        label: "男",
        value: "male",
      },
      {
        type: "radio",
        label: "女",
        value: "female",
      },
      {
        type: "radio",
        label: "保密",
        value: "not",
      },
    ],
  },
  {
    type: "upload",
    label: "上传",
    prop: "pic",
    uploadAttrs: {
      action: "https://run.mocky.io/v3/9d059bf9-4660-45f2-925d-ce80ad6c4d15",
    },
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "blur",
      },
    ],
  },
];

let handleRemove = (file: any, fileList: any) => {
  console.log("handleRemove");
  console.log(file, fileList);
};
let handlePreview = (file: any) => {
  console.log("handlePreview");
  console.log(file);
};
let beforeRemove = (val: any) => {
  console.log("beforeRemove");
  return ElMessageBox.confirm(`Cancel the transfert of ${val.file.name} ?`);
};
let handleExceed = (val: any) => {
  console.log("handleExceed", val);
  ElMessage.warning(
    `The limit is 3, you selected ${
      val.files.length
    } files this time, add up to ${
      val.files.length + val.fileList.length
    } totally`
  );
};
let handleSuccess = (val: any) => {
  console.log("success");
  console.log(val);
};
let handleChange = (val: any) => {
  console.log("change");
  console.log(val);
};
let handleBeforeUpload = (val: any) => {
  console.log("handleBeforeUpload");
  console.log(val);
};
</script>

<style scoped lang="scss"></style>

```

## 5-8 表单组件-巧用插槽给表单加上操作项

#### 1. 在配置项中设置多文件上传属性以及上传个数限制

`views/form/index.vue`

```ts
{
    type: "upload",
    label: "上传",
    prop: "pic",
    uploadAttrs: {
      action: "https://run.mocky.io/v3/9d059bf9-4660-45f2-925d-ce80ad6c4d15",
      multiple: true,
      limit: 3,
    },
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "blur",
      },
    ],
  },
```

#### 2. 配置自定义上传

`components/form/src/index.vue`

```vue
 <el-upload
          v-bind="item.uploadAttrs"
          v-else
          :on-preview="onPreview"
          :on-remove="onRemove"
          :on-success="onSuccess"
          :on-error="onError"
          :on-progress="onProgress"
          :on-change="onChange"
          :before-upload="beforeUpload"
          :before-remove="beforeRemove"
          :on-exceed="onExceed"
          :http-request="httpRequest"
        >
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
</el-upload>

<script>
let props = defineProps({
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
  // 用户自定义上传方法
  httpRequest: {
    type: Function,
  },
});
</script>


```

`views/form/index.vue`

```vue
<m-form
      label-width="100px"
      :options="options"
      @on-change="handleChange"
      @before-upload="handleBeforeUpload"
      @on-preview="handlePreview"
      @on-remove="handleRemove"
      @before-remove="beforeRemove"
      @on-success="handleSuccess"
      @on-exceed="handleExceed"
      :httpRequest="httpRequest"
    >
 
// 自定义上上传 
let httpRequest = () => {
  console.log("val");
};
```

#### 3. 设置表单操作项并渲染表单操作项

`components/form/src/index.vue`

```vue
<template>
  <el-form
    ref="form"
    v-if="model"
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options">
      <!-- 没有children -->
      <el-form-item
        :key="index"
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <!-- 如果type 不是 upload, 则使用component 加载对应的组件 -->
        <component
          v-if="item.type !== 'upload'"
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>

        <!-- 如果type 是 upload, 则使用el-upload组件 -->
        <el-upload
          v-bind="item.uploadAttrs"
          v-else
          :on-preview="onPreview"
          :on-remove="onRemove"
          :on-success="onSuccess"
          :on-error="onError"
          :on-progress="onProgress"
          :on-change="onChange"
          :before-upload="beforeUpload"
          :before-remove="beforeRemove"
          :on-exceed="onExceed"
          :http-request="httpRequest"
        >
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
        </el-upload>
      </el-form-item>
      <!-- 有children -->
      <el-form-item
        :key="index"
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
		<el-form-item>
        <slot name="action"></slot>
     </el-form-item>
  </el-form>
</template>
```

`views/form/index.vue`

```vue
<template>
  <div>
    <m-form
      label-width="100px"
      :options="options"
      @on-change="handleChange"
      @before-upload="handleBeforeUpload"
      @on-preview="handlePreview"
      @on-remove="handleRemove"
      @before-remove="beforeRemove"
      @on-success="handleSuccess"
      @on-exceed="handleExceed"
      :httpRequest="httpRequest"
    >
      <template #uploadArea>
        <el-button type="primary">Click to upload</el-button>
      </template>

      <template #uploadTip>
        <div style="color: #ccc; font-size: 12px">
          jpg/png files with a size less than 500KB.
        </div>
      </template>

      <template #action>
        <el-button type="primary" @click="submitForm"> 提交 </el-button>
        <el-button @click="resetForm">重置</el-button>
      </template>
    </m-form>
  </div>
</template>

let submitForm = () => {};
let resetForm = () => {};
```



#### 4. 给el-form设置ref,并设置表单ts类型

`components/form/src/index.vue`

```vue
<template>
  <el-form
    ref="form"
    v-if="model"
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options">
      <!-- 没有children -->
      <el-form-item
        :key="index"
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <!-- 如果type 不是 upload, 则使用component 加载对应的组件 -->
        <component
          v-if="item.type !== 'upload'"
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>

        <!-- 如果type 是 upload, 则使用el-upload组件 -->
        <el-upload
          v-bind="item.uploadAttrs"
          v-else
          :on-preview="onPreview"
          :on-remove="onRemove"
          :on-success="onSuccess"
          :on-error="onError"
          :on-progress="onProgress"
          :on-change="onChange"
          :before-upload="beforeUpload"
          :before-remove="beforeRemove"
          :on-exceed="onExceed"
          :http-request="httpRequest"
        >
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
        </el-upload>
      </el-form-item>
      <!-- 有children -->
      <el-form-item
        :key="index"
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
			<el-form-item>
        <slot name="action"></slot>
      </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import { ref, type PropType, onMounted, watch } from "vue";
import type { FormInstance, FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";

let form = ref<FormInstance | null>();
```

`components/form/src/types/types.ts`

```ts
// 可配置的表单

import type { RuleItem } from "./rule"

import type {CSSProperties} from "vue"

// 表单每一项的配置选项
export interface FormOptions {
    // 表单项显示的元素
    type : 'cascader' | 'checkbox' | 'checkbox-group' | 'checkbox-button' | 'color-picker' |
    'date-picker' | 'input' | 'input-number' | 'radio' | 'radio-group' | 'radio-button' | 'rate' |
    'select' | 'option' | 'slider' | 'switch' | 'time-picker' | 'time-select' |
    'transfer' | 'upload' | 'editor' 

    // 表单项值
    value? : any

    // 表单项标题
    label? : string

    // 表单项标识
    prop? : string

    // 表单项的验证规则
    rules? : RuleItem[]

    // 表单项的占位符
    placeholder? : string

    // 表单元素特有的属性
    attrs? : {
        // css样式
        style? : CSSProperties
        // 是否清空
        clearable?: boolean,
        // 是否显示密码
        showPassword?: boolean,
        // 是否禁用
        disabled?: boolean,
    }

    // 表单项的子元素
    children? : FormOptions[]

    // 处理上传组件的属性和方法
    uploadAttrs? : {
        action : string
        headers?: object,
        method?: 'post' | 'put' | 'patch',
        multiple?: boolean,
        data?: any,
        name?: string,
        withCredentials?: boolean,
        showFileList?: boolean,
        drag?: boolean,
        accept?: string,
        thumbnailMode?: boolean,
        fileList?: any[],
        listType?: 'text' | 'picture' | 'picture-card',
        autoUpload?: boolean,
        disabled?: boolean,
        limit?: number,
    }
}

import { ValidateFieldsError } from 'async-validator'
interface Callback {
  (isValid?: boolean, invalidFields?: ValidateFieldsError): void,
}

export interface ValidateFieldCallback {
    (message?: string, invalidFields?: ValidateFieldsError): void,
}

export interface FormInstance {
    registerLabelWidth(width: number, oldWidth: number): void,
    deregisterLabelWidth(width: number): void,
    autoLabelWidth: string | undefined,
    emit: (evt: string, ...args: any[]) => void,
    labelSuffix: string,
    inline?: boolean,
    model?: Record<string, unknown>,
    size?: string,
    showMessage?: boolean,
    labelPosition?: string,
    labelWidth?: string,
    rules?: Record<string, unknown>,
    statusIcon?: boolean,
    hideRequiredAsterisk?: boolean,
    disabled?: boolean,
    validate: (callback?: Callback) => Promise<boolean>,
    resetFields: () => void,
    clearValidate: (props?: string | string[]) => void,
    validateField: (props: string | string[], cb: ValidateFieldCallback) => void,
  }
```

#### 5. 使用作用域插槽实现将form表单以及form表单数据返回给父组件

`components/form/src/index.vue`

```vue
<el-form-item>
     <slot name="action" :form="form" :model="model"></slot>
</el-form-item>
```

`views/form/index.vue`

```vue
<template>
  <div>
    <m-form
      label-width="100px"
      :options="options"
      @on-change="handleChange"
      @before-upload="handleBeforeUpload"
      @on-preview="handlePreview"
      @on-remove="handleRemove"
      @before-remove="beforeRemove"
      @on-success="handleSuccess"
      @on-exceed="handleExceed"
      :httpRequest="httpRequest"
    >
      <template #uploadArea>
        <el-button type="primary">Click to upload</el-button>
      </template>

      <template #uploadTip>
        <div style="color: #ccc; font-size: 12px">
          jpg/png files with a size less than 500KB.
        </div>
      </template>

      <template #action="scope">
        <el-button type="primary" @click="submitForm(scope)"> 提交 </el-button>
        <el-button @click="resetForm(scope)">重置</el-button>
      </template>
    </m-form>
  </div>
</template>

<script lang="ts" setup>
import type {
  FormInstance,
  FormOptions,
} from "../../components/form/src/types/types";
import { ElMessage, ElMessageBox } from "element-plus";

interface Scope {
  form: FormInstance;
  model: any;
}

let submitForm = (scope: Scope) => {};
let resetForm = (scope: Scope) => {};
```

#### 6. 实现表单重置

```ts
let resetForm = (scope: Scope) => {
  scope.form.resetFields();
};
```

#### 7. 实现表单统一验证与数据提交

```ts
let submitForm = (scope: Scope) => {
  scope.form.validate((valid) => {
    if (valid) {
      console.log("scope", scope.model);
      ElMessage.success("submit!");
    } else {
      ElMessage.error("表单填写有误,请检查");
      return false;
    }
  });
};
```

#### 8. 先注释图片上传表单校验规则

## 5-9 表单组件-完善表单上传逻辑

#### 1. 解决表单上传成功时, 给表单上传项赋值

`components/form/src/index.vue`

```ts
let onSuccess = (response: any, file: File, fileList: FileList) => {
  // 上传图片成功 给表单上传项赋值
  let uploadItem = props.options.find((item) => item.type === "upload")!;
  model.value[uploadItem.prop!] = { response, file, fileList };
  emits("on-success", { response, file, fileList });
};
```

#### 2. 注释自定义上传方法httprequest

## 5-10 表单组件-集成富文本编辑器 wangeditor

官网: https://www.wangeditor.com/

#### 1. 下载插件

```shell
npm install @wangeditor/editor-for-vue@next --save
```

#### 2. 配置wangeditor表单配置项

```ts
{
    type: "editor",
    value: "",
    prop: "desc",
    label: "描述",
    rules: [
      {
        required: true,
        message: "描述不能为空",
        trigger: "blur",
      },
    ],
  },
```

#### 3. 根据type类型渲染wangeditor插件

```vue
  <!-- 没有children -->
      <el-form-item
        :key="index"
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <!-- 如果type 不是 upload, 则使用component 加载对应的组件 -->
        <component
          v-if="item.type !== 'upload' && item.type !== 'editor'"
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>

        <!-- 如果type 是 upload, 则使用el-upload组件 -->
        <el-upload
          v-bind="item.uploadAttrs"
          v-if="item.type === 'upload'"
          :on-preview="onPreview"
          :on-remove="onRemove"
          :on-success="onSuccess"
          :on-error="onError"
          :on-progress="onProgress"
          :on-change="onChange"
          :before-upload="beforeUpload"
          :before-remove="beforeRemove"
          :on-exceed="onExceed"
          :http-request="httpRequest"
        >
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
        </el-upload>

        <!-- 渲染wangeditor插件 -->
        <div v-if="item.type === 'editor'" style="border: 1px solid #ccc">
          <Toolbar
            style="border-bottom: 1px solid #ccc"
            :editor="editorRef"
            :defaultConfig="toolbarConfig"
            :mode="mode"
          />
          <Editor
            style="height: 500px; overflow-y: hidden"
            v-model="valueHtml"
            :defaultConfig="editorConfig"
            :mode="mode"
            @onCreated="handleCreated"
          />
        </div>
      </el-form-item>
      <!-- 有children -->
```

#### 4. 配置wangeditor插件

```vue
<template>
  <el-form
    ref="form"
    v-if="model"
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options">
      <!-- 没有children -->
      <el-form-item
        :key="index"
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <!-- 如果type 不是 upload, 则使用component 加载对应的组件 -->
        <component
          v-if="item.type !== 'upload' && item.type !== 'editor'"
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>

        <!-- 如果type 是 upload, 则使用el-upload组件 -->
        <el-upload
          v-bind="item.uploadAttrs"
          v-if="item.type === 'upload'"
          :on-preview="onPreview"
          :on-remove="onRemove"
          :on-success="onSuccess"
          :on-error="onError"
          :on-progress="onProgress"
          :on-change="onChange"
          :before-upload="beforeUpload"
          :before-remove="beforeRemove"
          :on-exceed="onExceed"
          :http-request="httpRequest"
        >
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
        </el-upload>

        <!-- 渲染wangeditor插件 -->
        <div v-if="item.type === 'editor'" style="border: 1px solid #ccc">
          <Toolbar
            style="border-bottom: 1px solid #ccc"
            :editor="editorRef"
            :defaultConfig="toolbarConfig"
            :mode="mode"
          />
          <Editor
            style="height: 500px; overflow-y: hidden"
            v-model="valueHtml"
            :defaultConfig="editorConfig"
            :mode="mode"
            @onCreated="handleCreated"
          />
        </div>
      </el-form-item>
      <!-- 有children -->
      <el-form-item
        :key="index"
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
    <el-form-item>
      <slot name="action" :form="form" :model="model"></slot>
    </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import {
  ref,
  type PropType,
  onMounted,
  watch,
  onBeforeUnmount,
  shallowRef,
} from "vue";
import type { FormInstance, FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
import "@wangeditor/editor/dist/css/style.css"; // 引入 css
import { Editor, Toolbar } from "@wangeditor/editor-for-vue";

// 编辑器实例，必须用 shallowRef
const editorRef = shallowRef();

// 内容 HTML
const valueHtml = ref("<p>hello</p>");

// 模拟 ajax 异步获取内容
onMounted(() => {
  setTimeout(() => {
    valueHtml.value = "<p>模拟 Ajax 异步设置内容</p>";
  }, 1500);
});

const toolbarConfig = {};
const editorConfig = { placeholder: "请输入内容..." };

// 组件销毁时，也及时销毁编辑器
onBeforeUnmount(() => {
  const editor = editorRef.value;
  if (editor == null) return;
  editor.destroy();
});

const handleCreated = (editor) => {
  editorRef.value = editor; // 记录 editor 实例，重要！
};
```

#### 5. 优化wangeditor配置

1. v-model绑定配置项prop的值
2. 将wangeditor的配置数据从外部的配置项配置

`components/form/src/index.vue`

```vue
<template>
  <el-form
    ref="form"
    v-if="model"
    :validate-on-rule-change="false"
    :model="model"
    :rules="rules"
    v-bind="$attrs"
  >
    <template v-for="(item, index) in options">
      <!-- 没有children -->
      <el-form-item
        :key="index"
        v-if="!item.children || !item.children!.length"
        :prop="item.prop"
        :label="item.label"
      >
        <!-- 如果type 不是 upload, 则使用component 加载对应的组件 -->
        <component
          v-if="item.type !== 'upload' && item.type !== 'editor'"
          v-bind="item.attrs"
          :placeholder="item.placeholder"
          v-model="model[item.prop!]"
          :is="`el-${item.type}`"
        ></component>

        <!-- 如果type 是 upload, 则使用el-upload组件 -->
        <el-upload
          v-bind="item.uploadAttrs"
          v-if="item.type === 'upload'"
          :on-preview="onPreview"
          :on-remove="onRemove"
          :on-success="onSuccess"
          :on-error="onError"
          :on-progress="onProgress"
          :on-change="onChange"
          :before-upload="beforeUpload"
          :before-remove="beforeRemove"
          :on-exceed="onExceed"
          :http-request="httpRequest"
        >
          <slot name="uploadArea"></slot>
          <slot name="uploadTip"></slot>
        </el-upload>

        <!-- 渲染wangeditor插件 -->
        <div
          id="editor"
          v-if="item.type === 'editor'"
          style="border: 1px solid #ccc"
        >
          <Toolbar
            style="border-bottom: 1px solid #ccc"
            :editor="editorRef"
            :defaultConfig="toolbarConfig"
            mode="default"
          />
          <Editor
            style="height: 500px; overflow-y: hidden"
            v-model="model[item.prop!]"
            :defaultConfig="{
              placeholder: item.placeholder,
              ...item.attrs,
            }"
            mode="default"
            @onCreated="handleCreated"
          />
        </div>
      </el-form-item>
      <!-- 有children -->
      <el-form-item
        :key="index"
        v-if="item.children && item.children.length"
        :prop="item.prop"
        :label="item.label"
      >
        <component
          v-bind="item.attrs"
          v-model="model[item.prop!]"
          :placeholder="item.placeholder"
          :is="`el-${item.type}`"
        >
          <component
            v-for="(child, i) in item.children"
            :key="i"
            :is="`el-${child.type}`"
            :label="child.label"
            :value="child.value"
          ></component>
        </component>
      </el-form-item>
    </template>
    <el-form-item>
      <slot name="action" :form="form" :model="model"></slot>
    </el-form-item>
  </el-form>
</template>

<script lang="ts" setup>
import {
  ref,
  type PropType,
  onMounted,
  watch,
  onBeforeUnmount,
  shallowRef,
} from "vue";
import type { FormInstance, FormOptions } from "./types/types";
import cloneDeep from "lodash/cloneDeep";
import "@wangeditor/editor/dist/css/style.css"; // 引入 css
import { Editor, Toolbar } from "@wangeditor/editor-for-vue";

// 编辑器实例，必须用 shallowRef
const editorRef = shallowRef();

// 内容 HTML
// const valueHtml = ref("<p>hello</p>");

// 模拟 ajax 异步获取内容
// onMounted(() => {
//   setTimeout(() => {
//     valueHtml.value = "<p>模拟 Ajax 异步设置内容</p>";
//   }, 1500);
// });

const toolbarConfig = {};
// const editorConfig = { placeholder: "请输入内容..." };

// 组件销毁时，也及时销毁编辑器
onBeforeUnmount(() => {
  const editor = editorRef.value;
  if (editor == null) return;
  editor.destroy();
});

const handleCreated = (editor) => {
  editorRef.value = editor; // 记录 editor 实例，重要！
};

```

`views/form/index.vue`

```ts
{
    type: "editor",
    value: "",
    prop: "desc",
    label: "描述",
    placeholder: "请输入描述内容",
    rules: [
      {
        required: true,
        message: "描述不能为空",
        trigger: "blur",
      },
    ],
  },
```



#### 官方示例

```vue
<template>
    <div style="border: 1px solid #ccc">
      <Toolbar
        style="border-bottom: 1px solid #ccc"
        :editor="editorRef"
        :defaultConfig="toolbarConfig"
        :mode="mode"
      />
      <Editor
        style="height: 500px; overflow-y: hidden;"
        v-model="valueHtml"
        :defaultConfig="editorConfig"
        :mode="mode"
        @onCreated="handleCreated"
      />
    </div>
</template>
```

```ts
<script>
import '@wangeditor/editor/dist/css/style.css' // 引入 css

import { onBeforeUnmount, ref, shallowRef, onMounted } from 'vue'
import { Editor, Toolbar } from '@wangeditor/editor-for-vue'

export default {
  components: { Editor, Toolbar },
  setup() {
    // 编辑器实例，必须用 shallowRef
    const editorRef = shallowRef()

    // 内容 HTML
    const valueHtml = ref('<p>hello</p>')

    // 模拟 ajax 异步获取内容
    onMounted(() => {
        setTimeout(() => {
            valueHtml.value = '<p>模拟 Ajax 异步设置内容</p>'
        }, 1500)
    })

    const toolbarConfig = {}
    const editorConfig = { placeholder: '请输入内容...' }

    // 组件销毁时，也及时销毁编辑器
    onBeforeUnmount(() => {
        const editor = editorRef.value
        if (editor == null) return
        editor.destroy()
    })

    const handleCreated = (editor) => {
      editorRef.value = editor // 记录 editor 实例，重要！
    }

    return {
      editorRef,
      valueHtml,
      mode: 'default', // 或 'simple'
      toolbarConfig,
      editorConfig,
      handleCreated
    };
  }
}
</script>  
```

## 5-11 表单组件-完善表单重置逻辑

本章是想讲解`wangeditor`插件数据重置, 但新版的wangeditor已经处理好了重置, 所以本小节跳过

## 5-12 表单组件-弹出框表单的基本结构

#### 1. 搭建结构

1. 创建modalForm组件并全局注册

   `components/modalForm/src/index.vue`

   ```vue
   <template>
     <div>modal 弹窗表单</div>
   </template>
   
   <script lang="ts" setup></script>
   
   <style scoped lang="scss"></style>
   
   ```

   `components/modalForm/index.ts`

   ```ts
   import { App } from "vue"
   import modalForm from "./src/index.vue"
   
   export default {
       install(app : App){
           app.component("m-modal-form", modalForm)
       }
   }
   ```

   `components/index.ts`

   ```ts
   import {App} from "vue"
   import chooseArea from "./chooseArea"
   import chooseIcon from "./chooseIcon"
   import menu from "./menu"
   import form from "./form"
   import modalForm from "./modalForm"
   
   const components = [
       chooseArea,
       chooseIcon,
       menu,
       form,
       modalForm
   ]
   
   export default {
       install(app : App){
           components.map(item => {
               app.use(item)
           })
       }
          
   }
   ```

   

2. 创建modalForm页面,并引入modalForm组件与使用

   `views/modalForm/index.vue`

   ```vue
   <template>
     <m-modal-form></m-modal-form>
   </template>
   
   <script lang="ts" setup></script>
   
   <style scoped lang="scss"></style>
   
   
   ```

3. 配置modalFor路由

   `router/index.ts`

   ```ts
   import {createRouter,createWebHistory,RouteRecordRaw} from "vue-router"
   import Home from "../views/Home.vue"
   import Container from "../components/container/src/index.vue"
   const routes : RouteRecordRaw[] = [
       {
           path : "/",
           component : Container,
           children : [
               {
                   path : "/",
                   component : Home
               },
               {
                   path : "/chooseIcon",
                   component : () => import("../views/chooseIcon/index.vue")
               },
               {
                   path : "/chooseArea",
                   component : () => import("../views/chooseArea/index.vue")
               },
               {
                   path : "/menu",
                   component : () => import("../views/menu/index.vue")
               },
               {
                   path : "/form",
                   component : () => import("../views/form/index.vue")
               },
             	{
                   path : "/modalForm",
                   component : () => import("../views/modalForm/index.vue")
               }
           ]
       },
       
   ]
   
   const router = createRouter({
       routes,
       history : createWebHistory()
   })
   
   export default router
   ```




#### 2. 实现点击按钮显示弹窗

`views/modalForm/index.vue`

```vue
<template>
  <div>
    <el-button type="primary" @click="open">open</el-button>
    <m-modal-form title="编辑用户" width="50%"></m-modal-form>
  </div>
</template>

<script lang="ts" setup>
import { ref } from "vue";


let visible = ref<boolean>(false);
let open = () => {
  visible.value = true;
};
</script>

<style lang="scss" scoped></style>

```

`components/modalForm/src/index.vue`

```vue
<template>
  <div >
    <el-dialog v-model="dialogVisible" v-bind="$attrs">
      
    </el-dialog>
  </div>
</template>

<script lang="ts" setup>
import {  ref, watch } from "vue";


let emits = defineEmits(["update:visible"]);


// 弹出框的显示与隐藏
let dialogVisible = ref<boolean>(props.visible);

watch(
  () => props.visible,
  (val) => {
    dialogVisible.value = val;
  }
);
watch(
  () => dialogVisible.value,
  (val) => {
    emits("update:visible", val);
  }
);
</script>

<style lang="scss" scoped></style>

```



#### 3. 实现底部操作按钮

`views/modalForm/index.vue`

```vue
<template>
  <div>
    <el-button type="primary" @click="open">open</el-button>
   <m-modal-form
      :options="options"
      title="编辑用户"
      width="50%"
      v-model:visible="visible"
    >
      <template #footer="scope">
        <el-button>取消</el-button>
        <el-button type="primary">确认</el-button>
      </template>
    </m-modal-form>
  </div>
</template>

<script lang="ts" setup>
import { ref } from "vue";


let visible = ref<boolean>(false);
let open = () => {
  visible.value = true;
};
</script>

<style lang="scss" scoped></style>

```

`components/modalForm/src/index.vue`

```vue
<template>
  <div >
    <el-dialog v-model="dialogVisible" v-bind="$attrs">
      <template #default>
      </template>
      <template #footer>
        <slot name="footer"></slot>
      </template>
    </el-dialog>
  </div>
</template>

<script lang="ts" setup>
import {  ref, watch } from "vue";


let emits = defineEmits(["update:visible"]);


// 弹出框的显示与隐藏
let dialogVisible = ref<boolean>(props.visible);

watch(
  () => props.visible,
  (val) => {
    dialogVisible.value = val;
  }
);
watch(
  () => dialogVisible.value,
  (val) => {
    emits("update:visible", val);
  }
);
</script>

<style lang="scss" scoped></style>

```





## 5-13 表单组件-使用 defineExpose 获取表单实例方法

#### 1. 实现父组件定义表单配置项数据, 子组件接受数据

`views/modalForm/index.vue`

```vue
<template>
  <div>
    <el-button type="primary" @click="open">open</el-button>
    <m-modal-form
    
      :options="options"
      title="编辑用户"
      width="50%"
      v-model:visible="visible"
  
    >
      <template #footer="scope">
        <el-button @click="cancel()">取消</el-button>
        <el-button type="primary" @click="confirm(scope.form)">确认</el-button>
      </template>
      <template #uploadArea>
        <el-button size="small" type="primary">Click to upload</el-button>
      </template>
      <template #uploadTip>
        <div style="color: #ccc; font-size: 12px">
          jpg/png files with a size less than 500kb
        </div>
      </template>
    </m-modal-form>
  </div>
</template>

<script lang="ts" setup>
import { ref } from "vue";
import { FormOptions } from "../../components/form/src/types/types";
import { ElMessage } from "element-plus";

let visible = ref<boolean>(false);
let open = () => {
  visible.value = true;
};
let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    placeholder: "请输入用户名",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    placeholder: "请输入密码",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    value: "",
    placeholder: "请选择职位",
    prop: "role",
    label: "职位",
    attrs: {
      style: {
        width: "100%",
      },
    },
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "change",
      },
    ],
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
  {
    type: "checkbox-group",
    value: [],
    prop: "like",
    label: "爱好",
    rules: [
      {
        required: true,
        message: "爱好不能为空",
        trigger: "change",
      },
    ],
    children: [
      {
        type: "checkbox",
        label: "足球",
        value: "1",
      },
      {
        type: "checkbox",
        label: "篮球",
        value: "2",
      },
      {
        type: "checkbox",
        label: "排球",
        value: "3",
      },
    ],
  },
  {
    type: "radio-group",
    value: "",
    prop: "gender",
    label: "性别",
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "change",
      },
    ],
    children: [
      {
        type: "radio",
        label: "男",
        value: "male",
      },
      {
        type: "radio",
        label: "女",
        value: "female",
      },
      {
        type: "radio",
        label: "保密",
        value: "not",
      },
    ],
  },
  {
    type: "upload",
    label: "上传",
    prop: "pic",
    uploadAttrs: {
      action: "https://jsonplaceholder.typicode.com/posts/",
      multiple: true,
      limit: 3,
    },
    rules: [
      {
        required: true,
        message: "图片不能为空",
        trigger: "blur",
      },
    ],
  },
  {
    type: "editor",
    value: "",
    prop: "desc",
    label: "描述",
    placeholder: "请输入描述",
    rules: [
      {
        required: true,
        message: "描述不能为空",
        trigger: "blur",
      },
    ],
  },
];


</script>

<style lang="scss" scoped></style>

```

`components/modalForm/src/index.vue`

```vue
<template>
  <div :class="{ 'm-choose-icon-dialog-body-height': isScroll }">
    <el-dialog v-model="dialogVisible" v-bind="$attrs">
      <template #default>
        <m-form
          ref="form"
          :options="options"
          label-width="100px"
         
        >
          <template #uploadArea>
            <slot name="uploadArea"></slot>
          </template>
          <template #uploadTip>
            <slot name="uploadTip"></slot>
          </template>
        </m-form>
      </template>
      <template #footer>
        <slot name="footer" :form="form"></slot>
      </template>
    </el-dialog>
  </div>
</template>

<script lang="ts" setup>
import { PropType, ref, watch } from "vue";
import { FormOptions } from "../../form/src/types/types";
let props = defineProps({
  
  visible: {
    type: Boolean,
    default: false,
  },
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
  
});
let emits = defineEmits(["update:visible"]);



// 弹出框的显示与隐藏
let dialogVisible = ref<boolean>(props.visible);

watch(
  () => props.visible,
  (val) => {
    dialogVisible.value = val;
  }
);
watch(
  () => dialogVisible.value,
  (val) => {
    emits("update:visible", val);
  }
);
</script>

<style lang="scss" scoped></style>

```



#### 2. 实现表单校验

`components/form/src/index.vue`

```ts

// 表单验证方法
let validate = () => {
  return form.value!.validate;
};
// 获取表单数据
let getFormData = () => {
  return model.value;
};

// 分发方法
defineExpose({
  validate,
  getFormData,
});
```



#### 3. 实现弹窗表单校验与获取表单数据

`components/modalForm/src/index.vue`

```vue
<template>
  <div :class="{ 'm-choose-icon-dialog-body-height': isScroll }">
    <el-dialog v-model="dialogVisible" v-bind="$attrs">
      <template #default>
        <m-form
          ref="form"
          :options="options"
          label-width="100px"
          @on-change="onChange"
          @before-upload="beforeUpload"
          @on-preview="onPreview"
          @on-remove="onRemove"
          @before-remove="beforeRemove"
          @on-success="onSuccess"
          @on-exceed="onExceed"
        >
          <template #uploadArea>
            <slot name="uploadArea"></slot>
          </template>
          <template #uploadTip>
            <slot name="uploadTip"></slot>
          </template>
        </m-form>
      </template>
      <template #footer>
        <slot name="footer" :form="form"></slot>
      </template>
    </el-dialog>
  </div>
</template>

<script lang="ts" setup>
import { PropType, ref, watch } from "vue";
import { FormOptions } from "../../form/src/types/types";
let props = defineProps({
  // 是否只在可视区域内滚动
  isScroll: {
    type: Boolean,
    default: false,
  },
  visible: {
    type: Boolean,
    default: false,
  },
  options: {
    type: Array as PropType<FormOptions[]>,
    required: true,
  },
  onChange: {
    type: Function,
  },
  beforeUpload: {
    type: Function,
  },
  onPreview: {
    type: Function,
  },
  onRemove: {
    type: Function,
  },
  beforeRemove: {
    type: Function,
  },
  onSuccess: {
    type: Function,
  },
  onExceed: {
    type: Function,
  },
});
let emits = defineEmits(["update:visible"]);

// 表单实例
let form = ref();

// 弹出框的显示与隐藏
let dialogVisible = ref<boolean>(props.visible);

watch(
  () => props.visible,
  (val) => {
    dialogVisible.value = val;
  }
);
watch(
  () => dialogVisible.value,
  (val) => {
    emits("update:visible", val);
  }
);
</script>

<style lang="scss" scoped></style>

```

`views/modalForm/index.vue`

```vue
<template>
  <div>
    <el-button type="primary" @click="open">open</el-button>
    <m-modal-form
      isScroll
      :options="options"
      title="编辑用户"
      width="50%"
      v-model:visible="visible"
      :on-change="handleChange"
      :on-success="handleSuccess"
    >
      <template #footer="scope">
        <el-button @click="cancel()">取消</el-button>
        <el-button type="primary" @click="confirm(scope.form)">确认</el-button>
        <!-- <el-button type="primary" @click="confirm(scope)">确认</el-button> -->
      </template>
      <template #uploadArea>
        <el-button size="small" type="primary">Click to upload</el-button>
      </template>
      <template #uploadTip>
        <div style="color: #ccc; font-size: 12px">
          jpg/png files with a size less than 500kb
        </div>
      </template>
    </m-modal-form>
  </div>
</template>

<script lang="ts" setup>
import { ref } from "vue";
import { FormOptions } from "../../components/form/src/types/types";
import { ElMessage } from "element-plus";

let visible = ref<boolean>(false);
let open = () => {
  visible.value = true;
};
let options: FormOptions[] = [
  {
    type: "input",
    value: "",
    label: "用户名",
    prop: "username",
    placeholder: "请输入用户名",
    rules: [
      {
        required: true,
        message: "用户名不能为空",
        trigger: "blur",
      },
      {
        min: 2,
        max: 6,
        message: "用户名在2-6位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      clearable: true,
    },
  },
  {
    type: "input",
    value: "",
    label: "密码",
    prop: "password",
    placeholder: "请输入密码",
    rules: [
      {
        required: true,
        message: "密码不能为空",
        trigger: "blur",
      },
      {
        min: 6,
        max: 15,
        message: "密码在6-15位之间",
        trigger: "blur",
      },
    ],
    attrs: {
      showPassword: true,
      clearable: true,
    },
  },
  {
    type: "select",
    value: "",
    placeholder: "请选择职位",
    prop: "role",
    label: "职位",
    attrs: {
      style: {
        width: "100%",
      },
    },
    rules: [
      {
        required: true,
        message: "职位不能为空",
        trigger: "change",
      },
    ],
    children: [
      {
        type: "option",
        label: "经理",
        value: "1",
      },
      {
        type: "option",
        label: "主管",
        value: "2",
      },
      {
        type: "option",
        label: "员工",
        value: "3",
      },
    ],
  },
  {
    type: "checkbox-group",
    value: [],
    prop: "like",
    label: "爱好",
    rules: [
      {
        required: true,
        message: "爱好不能为空",
        trigger: "change",
      },
    ],
    children: [
      {
        type: "checkbox",
        label: "足球",
        value: "1",
      },
      {
        type: "checkbox",
        label: "篮球",
        value: "2",
      },
      {
        type: "checkbox",
        label: "排球",
        value: "3",
      },
    ],
  },
  {
    type: "radio-group",
    value: "",
    prop: "gender",
    label: "性别",
    rules: [
      {
        required: true,
        message: "性别不能为空",
        trigger: "change",
      },
    ],
    children: [
      {
        type: "radio",
        label: "男",
        value: "male",
      },
      {
        type: "radio",
        label: "女",
        value: "female",
      },
      {
        type: "radio",
        label: "保密",
        value: "not",
      },
    ],
  },
  {
    type: "upload",
    label: "上传",
    prop: "pic",
    uploadAttrs: {
      action: "https://jsonplaceholder.typicode.com/posts/",
      multiple: true,
      limit: 3,
    },
    rules: [
      {
        required: true,
        message: "图片不能为空",
        trigger: "blur",
      },
    ],
  },
  {
    type: "editor",
    value: "",
    prop: "desc",
    label: "描述",
    placeholder: "请输入描述",
    rules: [
      {
        required: true,
        message: "描述不能为空",
        trigger: "blur",
      },
    ],
  },
];

let confirm = (form: any) => {
  let validate = form.validate();
  validate((valid: boolean) => {
    if (valid) {
      console.log(form.getFormData);
      ElMessage.success("验证成功");
    } else {
      ElMessage.error("表单填写有误,请检查");
    }
  });
};

let cancel = () => {};
let handleSuccess = (val: any) => {
  console.log("success");
  console.log(val);
};
let handleChange = (val: any) => {
  console.log("change");
  console.log(val);
};
</script>

<style lang="scss" scoped></style>

```



## 5-14 表单组件-完善表单逻辑

## 5-15 表单组件-表单组件总结

## 5-16 拓展动态添加和删除表单

**题目描述:**
通过前面的章节，我们已经完成了表单组件，因为表单通过配置选项生成的，我们可以任意增加或删除表单项。
**提示:**

1. 将配置选项定义为一个数组。
2. 对数组做增加或删除操作。

## 5-17 为表单增加自定义验证规则

**题目描述:**
通过前面的章节，我们已经完成了表单组件，现在为表单增加自定义验证规则。
**提示:**

1. 将配置选项定义`rules`时增加`validator`属性

## 5-18 为表单增加剩余实例方法

**题目描述:**
通过前面的章节，我们已经完成了表单组件，现在为表单增加剩余实例方法
**提示:**

1. 通过`defineExpose`暴露实例方法。
2. 暴露`validateField`、`scrollToField`、`clearValidate`方法

## 5-19 本章回顾

我们一起来回顾本章的重点内容

- 表单组件
  - 配置项类型定义
  - 动态组件的使用
  - 插槽的使用
  - 处理上传组件
  - 集成富文本编辑器
  - 支持弹框嵌套
  - `defineExpose`新属性的使用
  - 表单逻辑完善
