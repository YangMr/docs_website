# 项目难点

## 一、RBAC 权限

### 1.1 什么是 RBAC 权限?

所谓的 RBAC（Role-Based Access Control，基于⻆⾊的访问控制），其实就是⽤户通过⻆⾊与权限进⾏关
联。简单地说，⼀个⽤户拥有若⼲⻆⾊，每⼀个⻆⾊拥有若⼲权限。这样，就构造成“⽤户-⻆⾊-权限”的授权
模型。在这种模型中，⽤户与⻆⾊之间，⻆⾊与权限之间，⼀般者是多对多的关系

通俗的来讲,所谓的 rbac 权限其实指的是我们可以给⽤户分配⻆⾊,⻆⾊分配权限, 我们就可以做到不同的
⽤户登录看到不同的权限⻚⾯

### 1.2 菜单权限

所谓的菜单权限其实指的是⽤户后台主⻚的菜单栏的数据是动态的,⽽不是写死的,如果要想把菜单栏的数据变成动
态的,我们⼀般是通过两种⽅案来解决:

这块⼤家详细说第⼀种⽅案就⾏,第⼆种⽅案可以稍微提⼀下

1. 第⼀种⽅案

- 实现思路

`  菜单的数据⼀般是当我们登录成功之后,后台会给我们返回 token 以及⽤户相关信息,其中⽤户信息这块会包含菜单的数据、路由的数据、按钮权限的数据. 我们需要将这些数据存储到 vuex 和本地,
  接下来我们需要在主⻚组件中获取到 vuex ⾥⾯所存储到的菜单数据,利⽤ el-menu 将菜单的数据进⾏动态渲染`

- 难点

`但是菜单渲染这块有⼀个难点,后台给我们返回的菜单数据⼀般会是⼀个tree结构的数据,但是我们⽆法预测
这个tree结构的数据有多少层,如何直接使⽤el-menu进⾏渲染的时候就会存在⼀个问题,⽆法将tree结构
的数据完全渲染出来,所以这块我们需要使⽤vue递归组件去实现`

2. 第⼆种⽅案

- 实现思路

  `    菜单的数据不是后端来返回,⽽是前端通过动态路由表来⽣成菜单的数据. 具体实现思路是通过
this.$router.options.routes获取到完整的路由表,然后在封装⼀个递归⽅法,过滤出菜单所需要的数据,最
后在通过el-menu渲染成菜单.`

### 1.3 路由权限

1. **为什么需要有路由权限?**

   如果没有设置路由权限,就会导致任何⽤户登录之后拥有当前项⽬所有的⻚⾯权限,这样就会产⽣⽤户没有权限
   依然可以通过地址栏进⼊有权限的⻚⾯问题

2. **路由权限是什么?**

   所谓的路由权限指的是项⽬中的路由数据不是写死的,⽽是通过后台返回的路由权限数据进⾏动态渲染的. 如果
   ⽤户在浏览器地址访问了不存在的路由,我们则跳转到 404 ⻚⾯

3. **路由权限实现的思路:**

   - **第⼀种:**

     1. 当⽤户登录的时候,调⽤ getPermissionList 接⼝获取到后台所返回的路由表数据

     2. 定义⼀个递归⽅法,将后台所返回的路由表数据过滤成路由所需要的数据

     3. 在通过 router.addRoutes 动态的添加到路由表当中

   - **第⼆种:**

     1. 当⽤户登录的时候,调⽤ getPermissionList 接⼝获取到后台所返回的路由表数据 
     2. 在前端⾃定义⼀份路由表
     3. 根据后台所返回的路由权限,匹配出当前⽤户所拥有的⾃定义路由
     4. 将当前⽤所匹配出的⾃定义路由通过 router.addRoute 动态的添加到路由表中

4. 实现路由权限存在的问题与解决⽅案

   **问题:**

   1. 当⽤户退出登录之后, 再次进⾏登录,之前动态添加的路由依旧存在,就导致没有权限的⽤户依旧可以访问

   具有权限的路由

   2. 动态添加路由之后,再次刷新,会产⽣404问题

   **解决⽅案:**

   1.  **第一个问题的解决方案:**

      ⽤户退出登录的时候,需要调⽤router.removeRoute清除之前登录成功之后添加的路由, 就可以解决上⾯

      第⼀个问题

   2. **第二个问题产生的原因:**

      因为刷新⻚⾯⾛的是路由守卫中的next()跳转，⽽next默认获取的是当前动态路由路径，然⽽动态路由

      追加到真实路由的时候需要重绘时间，在next读取路由时，会先匹配到404

   3. **第二个问题解决方案:**

      - 将404匹配规则放在动态添加路由之后

      - 重定向next⾥⾯的路由跳转, ⻚⾯刷新的时候重定向next为to.fullPath,点击路由的时候由于不会执

      ⾏addRoute，所以直接放⾏next


### 1.4  按钮权限

- **什么是按钮权限?**

所谓的按钮权限是指在某个菜单的界⾯中， 我们需要根据按钮权限数据， 展示出可进⾏操作的按钮，⽐如删除， 修改， 增加等按钮

- **如何实现按钮的权限控制?**

如果要实现按钮的权限控制,我们需要使⽤vue的⾃定义指令去实现:

1. ⾸先需要创建⼀个按钮权限控制的指令,我们定义这个指令的名称为: `v-permission`
2. 在这个指令的内部获取到vuex⾥⾯存储的按钮权限数据
3. 在通过binding.value获取到⾃定义指令属性值的数据
4. 判断从vuex⾥⾯获取到的按钮权限数据是否包含了⾃定义指令包含的权限数据
5. 如果不包含,我们在设置el.style.display = “none”,并且使⽤el.parentNode.removeChild(el)删除当前按钮元素

- **具体实现代码**

```js
Vue.directive('permission', {
  beforeMount: function (el, binding) {
    let actionList = storage.getItem('actionList');
    let value = binding.value;
    let hasPermission = actionList.includes(value)
    if (!hasPermission) {
      el.style = 'display:none';
      setTimeout(() => {
      el.parentNode.removeChild(el);
     }, 0)
   }
  }
})
```

